<app-navbar></app-navbar>
<!-- <div class="card">
  <p-table
    #empAchievementTable
    [scrollable]="true"
    scrollHeight="360px"
    [value]="datas"
    dataKey="id"
    [rows]="10"
    [loading]="loading"
    [paginator]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    [tableStyle]="{
      'min-width': '50rem',
      'text-align': 'center',
      'font-size': '12px',
      margin: '0',
      'border-radius': '8px',
      'table-layout': 'fixed'
    }"
    [style]="{ width: '100%' }"
    [globalFilterFields]="[
      'id',
      'notes',
      'user_id.username',
      'achievement_id.achievement',
      'score',
      'assessment_year'
    ]"
    [sortField]="'created_at'"
    [sortOrder]="-1"
  >
    <ng-template pTemplate="caption">
      <div class="flex">
        <p-button
          id="btn-modal"
          (onClick)="showDialog()"
          label="Add Emp Achievement Skill"
          icon="pi pi-plus"
          [style]="{ 'font-size': '12px', padding: '10px 16px' }"
        />
        <p-iconField iconPosition="left" class="ml-auto">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input
            pInputText
            type="text"
            placeholder="Search keyword"
            (input)="onGlobalFilter(empAchievementTable, $event)"
            [style]="{ 'font-size': '14px' }"
          />
        </p-iconField>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 15%; text-align: center">Username</th>
        <th style="width: 25%; text-align: center">Achievement</th>
        <th style="width: 25%; text-align: center">Notes</th>
        <th style="width: 10%; text-align: center">Score</th>
        <th style="width: 10%; text-align: center">Assessment Year</th>
        <th style="width: 25%; text-align: center">Action</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-data>
      <tr [style]="{ padding: '0.5rem' }">
        <td [style]="{ padding: '0.5rem', 'text-align': 'center' }">
          {{ data.user_id?.username }}
        </td>
        <td [style]="{ padding: '0.5rem' }">
          {{ data.achievement_id.achievement }}
        </td>
        <td [style]="{ padding: '0.5rem' }">{{ data.notes }}</td>
        <td [style]="{ padding: '0.5rem', 'text-align': 'center' }">
          {{ data.score }}
        </td>
        <td [style]="{ padding: '0.5rem', 'text-align': 'center' }">
          {{ data.assessment_year }}
        </td>
        <td
          style="
            justify-content: space-evenly;
            display: flex;
            align-items: center;
          "
        >
          <p-button
            (onClick)="showDialogDetail(data)"
            label=""
            icon="pi pi-info-circle"
            [rounded]="true"
            [raised]="true"
            [style]="{ height: '40px', width: '40px' }"
          />
          <p-button
            (onClick)="showEditDialog(data)"
            severity="success"
            icon="pi pi-pen-to-square"
            [rounded]="true"
            [raised]="true"
            [style]="{ height: '40px', width: '40px' }"
          ></p-button>
          <p-button
            (onClick)="confirmDelete($event, data.id)"
            [outlined]="true"
            severity="danger"
            icon="pi pi-trash"
            [rounded]="true"
            [raised]="true"
            [style]="{ height: '40px', width: '40px' }"
          ></p-button>
        </td>
        <p-confirmDialog key="{{ data.id }}" />
      </tr>
    </ng-template>
  </p-table>
</div> -->

<!-- <div class="card flex justify-content-center">
  <p-dialog
    header="Add Emp Achievement"
    [(visible)]="visible"
    [style]="{ width: '52rem' }"
  >
    <form #empAchievementForm="ngForm" (submit)="createEmpAchievement()">
      <div class="flex align-items-center gap-8 mb-5">
        <label for="Notes" class="font-semibold w-6rem">
          Notes<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <input
            pInputText
            id="Notes"
            class="w-full"
            autocomplete="off"
            [(ngModel)]="newEmpAchievement.notes"
            required
            maxlength="100"
            name="notes"
            #notes="ngModel"
          />
          <div *ngIf="notes.invalid && (notes.dirty || notes.touched)">
            <small
              class="p-error block mt-1"
              *ngIf="notes.errors?.['required']"
            >
              Notes is required
            </small>
            <small
              class="p-error block mt-1"
              *ngIf="notes.errors?.['maxlength']"
            >
              Notes cannot exceed 100 characters
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="User Id"
          class="font-semibold w-6rem"
          style="width: 12rem; white-space: nowrap"
        >
          Employee<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <p-dropdown
            [options]="userDropdown"
            [(ngModel)]="newEmpAchievement.user_id"
            optionLabel="username"
            optionValue="id"
            placeholder="Select an employee"
            required
            name="employee"
            #employee="ngModel"
          />
          <div *ngIf="employee.invalid && (employee.dirty || employee.touched)">
            <small
              class="p-error block mt-1"
              *ngIf="employee.errors?.['required']"
            >
              Please select an employee
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="achievement id"
          class="font-semibold w-6rem"
          style="width: 12rem; white-space: nowrap"
        >
          Achievement Name<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <p-dropdown
            [options]="achievementDropdown"
            [(ngModel)]="newEmpAchievement.achievement_id"
            optionLabel="achievement"
            optionValue="id"
            placeholder="Achievement Name"
            required
            name="achievement"
            #achievement="ngModel"
          />
          <div
            *ngIf="
              achievement.invalid && (achievement.dirty || achievement.touched)
            "
          >
            <small
              class="p-error block mt-1"
              *ngIf="achievement.errors?.['required']"
            >
              Please select an achievement
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="Score"
          class="font-semibold w-6rem"
          style="width: 8rem; white-space: nowrap"
        >
          Score<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <input
            pInputText
            id="Score"
            class="w-full"
            autocomplete="off"
            [(ngModel)]="newEmpAchievement.score"
            required
            max="100"
            type="number"
            min="0"
            pattern="^[0-9]*$"
            name="score"
            #score="ngModel"
          />
          <div *ngIf="score.invalid && (score.dirty || score.touched)">
            <small
              class="p-error block mt-1"
              *ngIf="score.errors?.['required']"
            >
              Score is required
            </small>
            <small
              class="p-error block mt-1"
              *ngIf="score.errors?.['min'] || score.errors?.['max']"
            >
              Score must be between 0 and 100
            </small>
            <small class="p-error block mt-1" *ngIf="score.errors?.['pattern']">
              Score must be a number
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="Assessment Year"
          class="font-semibold w-6rem"
          style="width: 8rem; white-space: nowrap"
        >
          Assessment Year
        </label>
        <input
          pInputText
          id="Assessment Year"
          class="flex-auto"
          autocomplete="off"
          [(ngModel)]="newEmpAchievement.assessment_year"
          required
          [disabled]="true"
          name="year"
        />
      </div>

      <div class="flex justify-content-end gap-2">
        <p-button
          label="Cancel"
          severity="secondary"
          (onClick)="visible = false"
        />
        <p-button
          label="Save"
          (onClick)="visible = false"
          type="submit"
          [disabled]="empAchievementForm.invalid"
        />
      </div>
    </form>
  </p-dialog>
</div>

<div class="card flex justify-content-center">
  <p-dialog
    header="Edit Emp Achievement"
    [(visible)]="editVisible"
    [style]="{ width: '52rem' }"
  >
    <form #updateEmpAchievementForm="ngForm" (submit)="updateEmpAchievement()">
      <div class="flex align-items-center gap-8 mb-5">
        <label for="Notes" class="font-semibold w-6rem">
          Notes<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <input
            [(ngModel)]="editData.notes"
            pInputText
            id="Notes"
            class="w-full"
            autocomplete="off"
            required
            maxlength="100"
            name="notes"
            #editNotes="ngModel"
          />
          <div
            *ngIf="editNotes.invalid && (editNotes.dirty || editNotes.touched)"
          >
            <small
              class="p-error block mt-1"
              *ngIf="editNotes.errors?.['required']"
            >
              Notes is required
            </small>
            <small
              class="p-error block mt-1"
              *ngIf="editNotes.errors?.['maxlength']"
            >
              Notes cannot exceed 100 characters
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label for="User Id" class="font-semibold w-6rem">
          Employee<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <p-dropdown
            [options]="userDropdown"
            [(ngModel)]="editData.user_id"
            optionLabel="username"
            optionValue="id"
            placeholder="Select an employee"
            required
            name="employee"
            #editEmployee="ngModel"
          />
          <div
            *ngIf="
              editEmployee.invalid &&
              (editEmployee.dirty || editEmployee.touched)
            "
          >
            <small
              class="p-error block mt-1"
              *ngIf="editEmployee.errors?.['required']"
            >
              Please select an employee
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="Achievement Id"
          class="font-semibold w-6rem"
          style="width: 20rem; white-space: nowrap"
        >
          Achievement Name<span class="text-red-600">*</span>
        </label>
        <div class="flex-auto">
          <p-dropdown
            [options]="achievementDropdown"
            [(ngModel)]="editData.achievement_id"
            optionLabel="achievement"
            optionValue="id"
            placeholder=" Achievement Name "
            required
            name="achievement"
            #editAchievement="ngModel"
          />
          <div
            *ngIf="
              editAchievement.invalid &&
              (editAchievement.dirty || editAchievement.touched)
            "
          >
            <small
              class="p-error block mt-1"
              *ngIf="editAchievement.errors?.['required']"
            >
              Please select an achievement
            </small>
          </div>
        </div>
      </div>

      <div class="flex align-items-center gap-8 mb-5">
        <label for="Score" class="font-semibold w-6rem">
          Score<span class="text-red-600">*</span>
        </label>
        <input
          pInputText
          id="Score"
          class="flex-auto"
          autocomplete="off"
          [(ngModel)]="editData.score"
          required
          max="100"
          min="0"
          type="number"
          pattern="^[0-9]*$"
          name="score"
        />
      </div>
      <div class="flex align-items-center gap-8 mb-5">
        <label
          for="Assessment Year"
          class="font-semibold w-6rem"
          style="width: 20rem; white-space: nowrap"
        >
          Assessment Year
        </label>
        <input
          pInputText
          id="Assessment Year"
          class="flex-auto"
          autocomplete="off"
          [(ngModel)]="editData.assessment_year"
          name="assessment-year"
        />
      </div>
      <div class="flex justify-content-end gap-2">
        <p-button
          label="Cancel"
          severity="secondary"
          (onClick)="editVisible = false"
        />
        <p-button
          label="Save"
          (onClick)="editVisible = false"
          type="submit"
          [disabled]="updateEmpAchievementForm.invalid"
        />
      </div>
    </form>
  </p-dialog>
</div>

<div class="card flex justify-content-center">
  <p-dialog
    header="Emp Achievement Detail"
    [modal]="true"
    [(visible)]="detailVisible"
    [style]="{ width: '50rem' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  >
    <div class="card">
      <p-table
        #EmpAchievementTable
        [value]="[dataDetail]"
        dataKey="id"
        [loading]="loading"
        [tableStyle]="{
          'min-width': '50rem',
          'text-align': 'center',
          'font-size': '12px',
          margin: '0'
        }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Field</th>
            <th>Data</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-data>
          <tr>
            <td>Id</td>
            <td>{{ data.id }}</td>
          </tr>
          <tr>
            <td>User Id</td>
            <td>{{ data.user_id?.id }}</td>
          </tr>
          <tr>
            <td>Achievement Id</td>
            <td>{{ data.achievement_id?.id }}</td>
          </tr>
          <tr>
            <td>Notes</td>
            <td>{{ data.notes }}</td>
          </tr>
          <tr>
            <td>Score</td>
            <td>{{ data.score }}</td>
          </tr>
          <tr>
            <td>Assessment Year</td>
            <td>{{ data.assessment_year }}</td>
          </tr>
          <tr>
            <td>Created At</td>
            <td>{{ data.created_at }}</td>
          </tr>
          <tr>
            <td>Created By</td>
            <td>{{ data.created_by }}</td>
          </tr>
          <tr>
            <td>Updated At</td>
            <td>{{ data.updated_at }}</td>
          </tr>
          <tr>
            <td>Updated By</td>
            <td>{{ data.updated_by }}</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </p-dialog>
</div> -->
<app-user-information />

<p-table
  #userTable
  id="summaries-table"
  [scrollable]="true"
  scrollHeight="380px"
  [value]="users"
  dataKey="id"
  [rows]="10"
  [rowsPerPageOptions]="[10, 20, 50]"
  [loading]="loading"
  [paginator]="true"
  [tableStyle]="{
    'min-width': '50rem',
    'text-align': 'center',
    'font-size': '12px',
    margin: 0,
    'border-radius': '8px',
    'table-layout': 'fixed'
  }"
  [style]="{ width: '100%' }"
  [sortField]="'created_at'"
  [sortOrder]="-1"
>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 25%; text-align: center">
        <div class="flex flex-column align-items-center">
          <span>Full Name</span>
        </div>
      </th>
      <th style="width: 25%; text-align: center">
        <div class="flex flex-column align-items-center">
          <span>Username</span>
        </div>
      </th>
      <th style="width: 25%; text-align: center">
        <div class="flex flex-column align-items-center">
          <span>Position</span>
        </div>
      </th>
      <th style="width: 25%; text-align: center">
        <div class="flex flex-column align-items-center gap-2">
          <span>Division</span>
        </div>
      </th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-user>
    <tr class="clickable-row" (click)="showDialog(user)">
      <td>{{ user.full_name }}</td>
      <td style="text-align: center">{{ user.username }}</td>
      <td style="text-align: center">{{ user.position }}</td>
      <td style="text-align: center">
        {{ user.division?.division_name ?? "Unknown" }}
      </td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [header]="selectedUser.full_name + ' Achievement'"
  [modal]="true"
  [(visible)]="visible"
  [maximizable]="true"
  class="absolute z-5"
  appendTo="body"
>
  <div class="achievement-groups">
    <p-accordion [multiple]="true">
      <form #achievementForm="ngForm">
        <p-accordionTab
          *ngFor="let group of groupedAchievements"
          [header]="group.group_name"
        >
          <div class="p-4">
            <div class="mb-4" *ngFor="let achievement of group.achievements">
              <div class="flex align-items-center justify-content-between">
                <div class="flex-1">
                  <h3 class="text-lg font-semibold mb-2">
                    {{ achievement.achievement }}
                  </h3>
                  <div class="flex flex-column gap-3">
                    <div class="field">
                      <label for="score" class="block mb-1">
                        Score<span class="text-red-600">*</span>
                      </label>
                      <input
                        [(ngModel)]="
                          empAchievementRequests[achievement.id].score
                        "
                        pInputText
                        type="number"
                        id="score"
                        name="score"
                        required
                        min="0"
                        max="100"
                        class="w-full"
                        #scoreInput="ngModel"
                      />
                      <div
                        *ngIf="
                          scoreInput.invalid &&
                          (scoreInput.dirty || scoreInput.touched)
                        "
                      >
                        <small
                          class="p-error block mt-1"
                          *ngIf="scoreInput.errors?.['required']"
                        >
                          Score is required
                        </small>
                        <small
                          class="p-error block mt-1"
                          *ngIf="scoreInput.errors?.['min'] || scoreInput.errors?.['max']"
                        >
                          Score must be between 0 and 100
                        </small>
                      </div>
                    </div>

                    <!-- Notes Input -->
                    <div class="field">
                      <label for="notes" class="block mb-1">
                        Notes
                        <span class="text-red-600">*</span>
                      </label>
                      <!-- [(ngModel)]="achievement.notes" -->
                      <textarea
                        [(ngModel)]="
                          empAchievementRequests[achievement.id].notes
                        "
                        pInputTextarea
                        id="notes"
                        name="notes"
                        required
                        maxlength="100"
                        rows="3"
                        class="w-full"
                        #notesInput="ngModel"
                      ></textarea>
                      <div
                        *ngIf="
                          notesInput.invalid &&
                          (notesInput.dirty || notesInput.touched)
                        "
                      >
                        <small
                          class="p-error block mt-1"
                          *ngIf="notesInput.errors?.['required']"
                        >
                          Notes is required
                        </small>
                        <small
                          class="p-error block mt-1"
                          *ngIf="notesInput.errors?.['maxlength']"
                        >
                          Notes cannot exceed 100 characters
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <p-divider></p-divider>
            </div>
          </div>
        </p-accordionTab>
        <p-button
          type="submit"
          (onClick)="createEmpAchievement()"
          label="WAAAAA"
        />
      </form>
    </p-accordion>
  </div>
</p-dialog>
